<!doctype html>
<html>
	<head>
		<script>
			var baseURL = 'http://localhost:8080/';
			var updateURL = baseURL+'update';

			var fs = require('fs');
			var http = require('http');

			function getLocalVersion(cb) {
				fs.exists('./version', function(exists) {
					var v;
					if(exists) {
						v = fs.readFileSync('./version', 'utf8');
						cb(JSON.parse(v));
					} else {
						v = { major: 4, minor: 0, bf: 1 };
						fs.writeFileSync('./version', JSON.stringify(v));
						cb(v);
					}
				});
			}
			function getRemoteVersion(cb) {
				http.get(updateURL, function(res) {
					var result = '';
					res.on('data', function(chunk) {
						result += chunk;
					}).on('end', function() {
						cb(JSON.parse(result));
					})
				});
			}

			function isNewer(old, newer) {
				console.group('isNewer');
				console.log('old', old);
				console.log('new', newer)
				if(old.major === newer.major) {
					console.log('same major')
					if(old.minor === newer.minor) {
						console.log('same minor');
						if(old.bf === newer.bf) {
							console.log('same bf')
							if(old.build === newer.build) { console.log('same build');console.groupEnd('isNewer'); return false; }
							if(old.build < newer.build) { console.log('old build is older');console.groupEnd('isNewer'); return true; }
						}
						if(old.bf < newer.bf) { console.log('old bf is older');console.groupEnd('isNewer'); return true; }
					}
					if(old.minor < newer.minor) { console.log('old minor is older');console.groupEnd('isNewer'); return true; }
				}
				if(old.major < newer.major) { console.log('old major is older');console.groupEnd('isNewer'); return true; }
				console.log('old is actually newer than newer')
				console.groupEnd('isNewer');
				return false;
			}


			function collectFiles(local, up) {
				var ret = [];
				for(var i = 0; i < up.length; i++) {
					if(isNewer(local, up[i].version)) {
						ret = ret.concat(up[i].files);
					}
				}
				return ret;
			}

			function fetch(files, cb) {

			}


			getLocalVersion(function(lv) {
				getRemoteVersion(function(up) {
					if(isNewer(lv, up[up.length-1].version)) {
						var f = collectFiles(lv, up);
						fetch(f, function() {
							console.log('foo')
						});
					}
				});
			});
		</script>
		<style>

		</style>
	</head>
	<body>
	</body>
</html>